<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProManage - Project Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar for better UI */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Print Media Queries */
        @media print {
            aside, header, .print-hide { display: none !important; }
            main { padding: 0 !important; overflow: visible !important; height: auto !important; }
            .gantt-container { border: none !important; box-shadow: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body { background-color: white !important; }
            #app-container { height: auto !important; overflow: visible !important; display: block !important;}
        }

        /* Tooltip Hover Area */
        .gantt-bar-group:hover .gantt-tooltip { display: block; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 h-screen overflow-hidden">

    <div id="app-container" class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-xl font-bold text-indigo-600 flex items-center gap-2">
                    <i data-lucide="layout-dashboard"></i> ProManage
                </h1>
            </div>
            <nav class="flex-1 p-4 space-y-2" id="nav-menu">
                <!-- Rendered by JS -->
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 py-4 px-8 flex justify-between items-center">
                <h2 id="header-title" class="text-2xl font-semibold text-gray-800 capitalize">Dashboard</h2>
                <div class="flex items-center gap-3">
                    <input type="file" accept=".csv" id="csvFileInput" style="display: none;" onchange="window.handleImportCSV(event)" />
                    
                    <button onclick="document.getElementById('csvFileInput').click()" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2 rounded-lg flex items-center gap-2 transition-colors shadow-sm text-sm" title="‡∏≠‡∏¥‡∏°‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏à‡∏≤‡∏Å CSV">
                        <i data-lucide="upload" class="w-4 h-4"></i><span class="hidden md:inline">Import</span>
                    </button>

                    <button onclick="window.handleExportCSV()" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2 rounded-lg flex items-center gap-2 transition-colors shadow-sm text-sm" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV">
                        <i data-lucide="download" class="w-4 h-4"></i><span class="hidden md:inline">Export</span>
                    </button>

                    <button onclick="window.openPrintModal()" class="bg-white border border-gray-300 hover:bg-indigo-50 hover:border-indigo-300 text-indigo-600 px-3 py-2 rounded-lg flex items-center gap-2 transition-colors shadow-sm text-sm" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                        <i data-lucide="printer" class="w-4 h-4"></i><span class="hidden md:inline">Print</span>
                    </button>

                    <div class="w-px h-6 bg-gray-300 mx-1"></div>

                    <button onclick="window.openTaskModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors shadow-sm text-sm md:text-base">
                        <i data-lucide="plus" class="w-4 h-4"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </header>

            <!-- Dynamic View Content -->
            <div id="main-content" class="flex-1 overflow-auto p-4 md:p-8 gantt-container">
                <!-- Content injected here -->
            </div>
        </main>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black/50 items-center justify-center z-50 p-4 print-hide hidden flex">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 id="task-modal-title" class="text-lg font-bold text-gray-800">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <button onclick="window.closeTaskModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="task-form" class="p-6 space-y-4" onsubmit="window.submitTaskForm(event)">
                <input type="hidden" name="id" id="task-id">
                <input type="hidden" name="parentId" id="task-parent-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô *</label>
                    <input required name="title" id="task-title" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÇ‡∏•‡πÇ‡∏Å‡πâ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label>
                    <textarea name="description" id="task-desc" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö *</label>
                        <input required name="assignee" id="task-assignee" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
                        <select name="priority" id="task-priority" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="Low">Low (‡∏ï‡πà‡∏≥)</option>
                            <option value="Medium" selected>Medium (‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)</option>
                            <option value="High">High (‡∏™‡∏π‡∏á)</option>
                            <option value="Urgent">Urgent (‡∏î‡πà‡∏ß‡∏ô)</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (Start) *</label>
                        <input required name="startDate" id="task-start" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á (Finish) *</label>
                        <input required name="dueDate" id="task-due" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Progress %) *</label>
                    <input required name="progress" id="task-progress" type="number" min="0" max="100" value="0" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0-100">
                    <p class="text-xs text-gray-500 mt-1">‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ 0 - 100 (‡∏´‡∏≤‡∏Å‡πÉ‡∏™‡πà 100 ‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô Done ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</p>
                </div>
                <div class="pt-4 mt-6 border-t border-gray-100 flex justify-end gap-3">
                    <button type="button" onclick="window.closeTaskModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" id="task-submit-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors font-medium">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Print Config Modal -->
    <div id="print-modal" class="fixed inset-0 bg-black/50 items-center justify-center z-50 p-4 print-hide hidden flex">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="printer" class="w-5 h-5 text-indigo-600"></i> ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå (Print Setup)
                </h3>
                <button onclick="window.closePrintModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6 space-y-5">
                <div class="space-y-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="printType" value="all" checked onchange="window.updatePrintOptions('type', 'all')" class="text-indigo-600 focus:ring-indigo-500" />
                        <span class="text-gray-700 font-medium">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Print All)</span>
                    </label>
                    
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="printType" value="task" onchange="window.updatePrintOptions('type', 'task')" class="text-indigo-600 focus:ring-indigo-500" />
                        <span class="text-gray-700 font-medium">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏á‡∏≤‡∏ô (Task ID Rank)</span>
                    </label>
                    <div id="print-task-inputs" class="flex items-center gap-3 pl-6 mt-2 hidden">
                        <input type="number" id="print-task-start" min="1" class="w-16 border rounded px-2 py-1 text-sm outline-none focus:border-indigo-500" onchange="window.updatePrintOptions('taskStart', this.value)"/>
                        <span class="text-gray-500 text-sm">‡∏ñ‡∏∂‡∏á</span>
                        <input type="number" id="print-task-end" min="1" class="w-16 border rounded px-2 py-1 text-sm outline-none focus:border-indigo-500" onchange="window.updatePrintOptions('taskEnd', this.value)"/>
                    </div>

                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="printType" value="date" onchange="window.updatePrintOptions('type', 'date')" class="text-indigo-600 focus:ring-indigo-500" />
                        <span class="text-gray-700 font-medium">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Date Range)</span>
                    </label>
                    <div id="print-date-inputs" class="flex flex-col gap-2 pl-6 mt-2 hidden">
                        <input type="date" id="print-date-start" class="border rounded px-2 py-1 text-sm outline-none focus:border-indigo-500" onchange="window.updatePrintOptions('dateStart', this.value)"/>
                        <span class="text-gray-500 text-sm text-center">‡∏ñ‡∏∂‡∏á</span>
                        <input type="date" id="print-date-end" class="border rounded px-2 py-1 text-sm outline-none focus:border-indigo-500" onchange="window.updatePrintOptions('dateEnd', this.value)"/>
                    </div>
                </div>

                <div class="bg-blue-50 text-blue-800 text-xs p-3 rounded-lg flex gap-2">
                    <i data-lucide="alert-circle" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
                    <p><b>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á Gantt Chart ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏õ‡πá‡∏ô <b>‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (Landscape)</b> ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Print</p>
                </div>

                <div class="pt-2 border-t border-gray-100 flex justify-end gap-3">
                    <button onclick="window.closePrintModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="window.confirmPrint()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors font-medium flex items-center gap-2">
                        <i data-lucide="printer" class="w-4 h-4"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- Constants & Data ---
        const STATUSES = ['To Do', 'In Progress', 'Review', 'Done'];
        const PRIORITIES = ['Low', 'Medium', 'High', 'Urgent'];
        
        const initialTasks = [
            { id: '1', title: '‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ UI/UX', description: '‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡πÅ‡∏•‡∏∞ Kanban board ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà', assignee: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢', status: 'In Progress', priority: 'High', startDate: '2026-02-01', dueDate: '2026-02-12', progress: 60 },
            { id: '2', title: '‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö Backend', description: '‡∏™‡∏£‡πâ‡∏≤‡∏á API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Tasks ‡πÅ‡∏•‡∏∞ Users', assignee: '‡∏™‡∏°‡∏®‡∏£‡∏µ', status: 'To Do', priority: 'Urgent', startDate: '2026-02-05', dueDate: '2026-02-18', progress: 10 },
            { id: '3', title: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (QA)', description: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏ö‡∏±‡πä‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á', assignee: '‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå', status: 'To Do', priority: 'Medium', startDate: '2026-02-19', dueDate: '2026-02-25', progress: 0 },
            { id: '4', title: '‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', description: '‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ Prototype ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å', assignee: '‡∏™‡∏°‡∏´‡∏°‡∏≤‡∏¢', status: 'Done', priority: 'High', startDate: '2026-02-13', dueDate: '2026-02-13', progress: 100 },
            { id: '5', title: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ User Manual', description: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', assignee: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢', status: 'Review', priority: 'Low', startDate: '2026-02-20', dueDate: '2026-02-28', progress: 90 },
        ];

        // --- State ---
        let tasks = [];
        let currentView = 'gantt'; // 'dashboard', 'gantt', 'kanban', 'list'
        let draggedTaskId = null;
        let printConfig = null;
        let printOptions = {
            type: 'all', 
            taskStart: 1,
            taskEnd: 5,
            dateStart: new Date().toISOString().split('T')[0],
            dateEnd: new Date(Date.now() + 86400000*30).toISOString().split('T')[0]
        };

        // --- Initialization ---
        function init() {
            const saved = localStorage.getItem('promanage_tasks');
            if (saved) {
                try { tasks = JSON.parse(saved); } catch(e) { tasks = initialTasks; }
            } else {
                tasks = initialTasks;
            }
            printOptions.taskEnd = tasks.length || 1;
            renderAll();
        }

        // --- Rendering Core ---
        function renderAll() {
            renderSidebar();
            renderHeader();
            renderContent();
            lucide.createIcons(); // Re-initialize icons
        }

        function saveAndRender() {
            localStorage.setItem('promanage_tasks', JSON.stringify(tasks));
            printOptions.taskEnd = tasks.length || 1;
            renderAll();
        }

        window.changeView = function(view) {
            currentView = view;
            renderAll();
        }

        // --- View Renderers ---
        function renderSidebar() {
            const nav = document.getElementById('nav-menu');
            const menuItems = [
                { id: 'dashboard', icon: 'layout-dashboard', label: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Dashboard)' },
                { id: 'gantt', icon: 'bar-chart-horizontal', label: 'Gantt Chart' },
                { id: 'kanban', icon: 'kanban-square', label: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏á‡∏≤‡∏ô (Kanban)' },
                { id: 'list', icon: 'list', label: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (List)' }
            ];

            nav.innerHTML = menuItems.map(item => `
                <button onclick="window.changeView('${item.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors ${currentView === item.id ? 'bg-indigo-50 text-indigo-700 font-medium' : 'text-gray-600 hover:bg-gray-100'}">
                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                    ${item.label}
                </button>
            `).join('');
        }

        function renderHeader() {
            const titles = { 'dashboard': 'Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°', 'gantt': 'Gantt Chart (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô)', 'kanban': 'Kanban Board', 'list': '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' };
            document.getElementById('header-title').innerText = titles[currentView] || '';
        }

        function renderContent() {
            const container = document.getElementById('main-content');
            let visibleTasks = getVisibleTasks();

            if (currentView === 'dashboard') container.innerHTML = getDashboardHTML(visibleTasks);
            else if (currentView === 'gantt') container.innerHTML = getGanttHTML(visibleTasks);
            else if (currentView === 'kanban') container.innerHTML = getKanbanHTML(visibleTasks);
            else if (currentView === 'list') container.innerHTML = getListHTML(visibleTasks);
        }

        // --- Derived Data ---
        function getVisibleTasks() {
            if (!printConfig) return tasks;
            if (printConfig.type === 'task') {
                const start = Math.max(0, parseInt(printConfig.taskStart, 10) - 1);
                const end = parseInt(printConfig.taskEnd, 10);
                return tasks.slice(start, end);
            }
            if (printConfig.type === 'date') {
                return tasks.filter(t => t.startDate && t.dueDate && t.startDate <= printConfig.dateEnd && t.dueDate >= printConfig.dateStart);
            }
            return tasks;
        }

        // --- Tree Structure Helper ---
        function getTreeTasks(tasksArray) {
            const result = [];
            const addedIds = new Set();

            // 1. ‡∏î‡∏∂‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ parentId)
            tasksArray.forEach(t => {
                if (!t.parentId && !addedIds.has(t.id)) {
                    result.push({ ...t, level: 0 });
                    addedIds.add(t.id);
                    
                    // 2. ‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ
                    tasksArray.forEach(child => {
                        if (child.parentId === t.id && !addedIds.has(child.id)) {
                            result.push({ ...child, level: 1 });
                            addedIds.add(child.id);
                        }
                    });
                }
            });

            // 3. ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏∏‡∏î (‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏ñ‡∏π‡∏Å filter ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ)
            tasksArray.forEach(t => {
                if (!addedIds.has(t.id)) {
                    result.push({ ...t, level: 0 }); 
                    addedIds.add(t.id);
                }
            });

            return result;
        }

        function getStats(tList) {
            const total = tList.length;
            const done = tList.filter(t => t.status === 'Done').length;
            const inProgress = tList.filter(t => t.status === 'In Progress').length;
            const review = tList.filter(t => t.status === 'Review').length;
            const progress = total === 0 ? 0 : Math.round((done / total) * 100);
            return { total, done, inProgress, review, progress };
        }

        function getGanttData(tList) {
            let minDate = new Date();
            let maxDate = new Date();
            let hasDates = false;

            if (printConfig && printConfig.type === 'date') {
                minDate = new Date(printConfig.dateStart);
                maxDate = new Date(printConfig.dateEnd);
                hasDates = true;
            } else {
                tList.forEach(t => {
                    if (t.startDate) {
                        const d = new Date(t.startDate);
                        if (!hasDates || d < minDate) minDate = d;
                        hasDates = true;
                    }
                    if (t.dueDate) {
                        const d = new Date(t.dueDate);
                        if (!hasDates || d > maxDate) maxDate = d;
                        hasDates = true;
                    }
                });

                if (!hasDates) {
                    const now = new Date();
                    minDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    maxDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                } else {
                    minDate = new Date(minDate); minDate.setDate(minDate.getDate() - 2);
                    maxDate = new Date(maxDate); maxDate.setDate(maxDate.getDate() + 7);
                }
            }

            const days = [];
            let curr = new Date(minDate);
            while (curr <= maxDate) { days.push(new Date(curr)); curr.setDate(curr.getDate() + 1); }

            const months = [];
            let curMonthStr = null;
            let count = 0;
            days.forEach(d => {
                const mStr = d.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                if (mStr !== curMonthStr) {
                    if (curMonthStr) months.push({ label: curMonthStr, colSpan: count });
                    curMonthStr = mStr; count = 1;
                } else { count++; }
            });
            if (curMonthStr) months.push({ label: curMonthStr, colSpan: count });

            return { minDate, maxDate, days, months };
        }

        // --- HTML Generators ---
        function getDashboardHTML(vTasks) {
            const stats = getStats(vTasks);
            const urgentTasks = vTasks.filter(t => t.priority === 'Urgent' && t.status !== 'Done');
            
            return `
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4">
                        <div class="p-3 bg-indigo-100 text-indigo-600 rounded-lg"><i data-lucide="list"></i></div>
                        <div><p class="text-sm text-gray-500 font-medium">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p class="text-2xl font-bold">${stats.total}</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4">
                        <div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="clock"></i></div>
                        <div><p class="text-sm text-gray-500 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p><p class="text-2xl font-bold">${stats.inProgress}</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4">
                        <div class="p-3 bg-purple-100 text-purple-600 rounded-lg"><i data-lucide="alert-circle"></i></div>
                        <div><p class="text-sm text-gray-500 font-medium">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</p><p class="text-2xl font-bold">${stats.review}</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4">
                        <div class="p-3 bg-green-100 text-green-600 rounded-lg"><i data-lucide="check-circle"></i></div>
                        <div><p class="text-sm text-gray-500 font-medium">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p><p class="text-2xl font-bold">${stats.done}</p></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="col-span-1 lg:col-span-2 bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                        <h3 class="text-lg font-bold mb-4">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h3>
                        <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                            <div class="bg-indigo-600 h-4 rounded-full transition-all duration-500" style="width: ${stats.progress}%"></div>
                        </div>
                        <p class="text-right text-sm text-gray-600 font-medium">${stats.progress}% ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</p>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                        <h3 class="text-lg font-bold mb-4">‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô (Urgent Tasks)</h3>
                        <div class="space-y-3">
                            ${urgentTasks.length === 0 ? `<p class="text-sm text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ üéâ</p>` : 
                            urgentTasks.map(task => `
                                <div class="p-3 border border-red-200 bg-red-50 rounded-lg flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold text-sm text-gray-800">${task.title}</p>
                                        <p class="text-xs text-gray-500 mt-1 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> Due: ${task.dueDate}</p>
                                    </div>
                                    <button onclick="window.openTaskModal('${task.id}')" class="print-hide text-gray-400 hover:text-indigo-600 p-1"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function getListHTML(vTasks) {
            const treeTasks = getTreeTasks(vTasks);
            return `
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-500 text-sm border-b border-gray-200">
                            <th class="p-4 font-medium w-12 text-center">ID</th>
                            <th class="p-4 font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô (Task Name)</th>
                            <th class="p-4 font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
                            <th class="p-4 font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</th>
                            <th class="p-4 font-medium">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                            <th class="print-hide p-4 font-medium text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 text-sm">
                        ${treeTasks.length === 0 ? `<tr><td colspan="6" class="text-center p-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</td></tr>` : 
                        treeTasks.map((task, index) => {
                            const indent = task.level > 0 ? 'pl-8 text-gray-600' : 'font-medium text-gray-800';
                            const prefix = task.level > 0 ? '‚Ü≥ ' : '';
                            return `
                            <tr class="hover:bg-gray-50 transition-colors ${task.level > 0 ? 'bg-gray-50/30' : ''}">
                                <td class="p-4 text-center text-gray-500">${printConfig && printConfig.type === 'task' ? parseInt(printConfig.taskStart) + index : index + 1}</td>
                                <td class="p-4 ${indent}">
                                    <p class="flex items-center gap-2 group">
                                        ${prefix}${task.title}
                                        ${task.level === 0 ? `<button onclick="window.openTaskModal(null, true, '${task.id}')" class="text-green-500 hover:text-green-700 opacity-0 group-hover:opacity-100 transition-opacity" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢"><i data-lucide="plus-circle" class="w-4 h-4"></i></button>` : ''}
                                    </p>
                                    <p class="text-xs text-gray-500 truncate max-w-xs ${task.level > 0 ? 'ml-4' : ''}">${task.description || ''}</p>
                                </td>
                                <td class="p-4">
                                    <div class="flex items-center gap-2">
                                        <div class="w-16 bg-gray-200 rounded-full h-1.5"><div class="bg-blue-500 h-1.5 rounded-full" style="width: ${task.progress || 0}%"></div></div>
                                        <span class="text-xs text-gray-600 font-medium">${task.progress || 0}%</span>
                                    </div>
                                </td>
                                <td class="p-4">
                                    <select onchange="window.handleStatusChange('${task.id}', this.value)" class="text-xs px-2.5 py-1.5 rounded-full font-medium outline-none border-none cursor-pointer ${getStatusColor(task.status)}" style="appearance: none; -webkit-appearance: none;">
                                        ${STATUSES.map(s => `<option value="${s}" ${task.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </td>
                                <td class="p-4 flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs">${task.assignee.charAt(0)}</div>
                                    <span>${task.assignee}</span>
                                </td>
                                <td class="print-hide p-4 text-right space-x-3">
                                    <button onclick="window.openTaskModal('${task.id}')" class="text-indigo-600 hover:text-indigo-800 font-medium">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <button onclick="window.deleteTask('${task.id}')" class="text-red-500 hover:text-red-700 font-medium">‡∏•‡∏ö</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            </div>`;
        }

        function getKanbanHTML(vTasks) {
            const treeTasks = getTreeTasks(vTasks);
            let html = `<div class="flex h-full gap-6 overflow-x-auto pb-4">`;
            STATUSES.forEach(status => {
                const sTasks = treeTasks.filter(t => t.status === status);
                const dotColor = status === 'Done' ? 'bg-green-500' : status === 'In Progress' ? 'bg-blue-500' : status === 'Review' ? 'bg-purple-500' : 'bg-gray-400';
                
                html += `
                <div class="flex-shrink-0 w-80 bg-gray-100 rounded-xl flex flex-col" ondragover="window.handleDragOver(event)" ondrop="window.handleDrop(event, '${status}')">
                    <div class="p-4 flex justify-between items-center border-b border-gray-200">
                        <h3 class="font-semibold text-gray-700 flex items-center gap-2"><div class="w-3 h-3 rounded-full ${dotColor}"></div>${status}</h3>
                        <span class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full font-medium">${sTasks.length}</span>
                    </div>
                    <div class="flex-1 p-3 overflow-y-auto space-y-3">
                        ${sTasks.map(task => `
                            <div draggable="true" ondragstart="window.handleDragStart(event, '${task.id}')" ondragend="window.handleDragEnd(event)" class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 cursor-grab active:cursor-grabbing hover:border-indigo-300 transition-colors group relative">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs px-2 py-1 rounded-md border font-medium ${getPriorityColor(task.priority)}">${task.priority}</span>
                                    <button onclick="window.openTaskModal('${task.id}')" class="print-hide text-gray-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-1">${task.level > 0 ? '‚Ü≥ ' : ''}${task.title}</h4>
                                <p class="text-sm text-gray-500 mb-3 line-clamp-2">${task.description || ''}</p>
                                <div class="mb-3">
                                    <div class="flex justify-between text-xs mb-1 text-gray-500"><span>Progress</span><span class="font-medium text-gray-700">${task.progress || 0}%</span></div>
                                    <div class="w-full bg-gray-100 rounded-full h-1.5"><div class="bg-blue-500 h-1.5 rounded-full" style="width: ${task.progress || 0}%"></div></div>
                                </div>
                                <div class="flex justify-between items-center mt-auto border-t border-gray-100 pt-3">
                                    <div class="flex items-center gap-1.5 text-xs text-gray-500"><i data-lucide="user" class="w-3.5 h-3.5 text-gray-400"></i>${task.assignee}</div>
                                    <div class="flex items-center gap-1.5 text-xs text-gray-500"><i data-lucide="calendar" class="w-3.5 h-3.5 text-gray-400"></i>${task.dueDate || '-'}</div>
                                </div>
                            </div>
                        `).join('')}
                        <div class="print-hide h-full min-h-[50px] rounded-lg border-2 border-dashed border-transparent"></div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            return html;
        }

        function getGanttHTML(vTasks) {
            const gData = getGanttData(vTasks);
            const treeTasks = getTreeTasks(vTasks);
            const timelineLabel = gData.months.length > 0 ? `${gData.months[0].label} ${gData.months.length > 1 ? '- ' + gData.months[gData.months.length-1].label : ''}` : '';

            let html = `
            <div class="flex flex-col h-full bg-white border border-gray-300 rounded-lg shadow-sm overflow-hidden gantt-container">
                <div class="print-hide bg-gray-100 border-b border-gray-300 px-4 py-2 flex items-center gap-4 text-sm font-medium text-gray-700">
                    <button onclick="window.openTaskModal()" class="flex items-center gap-1 hover:text-indigo-600"><i data-lucide="plus" class="w-4 h-4"></i> New Task</button>
                    <div class="w-px h-4 bg-gray-300"></div>
                    <span class="text-gray-500 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> Timeline: ${timelineLabel}</span>
                </div>
                <div class="flex flex-1 overflow-hidden">
                    
                    <!-- Left Pane -->
                    <div class="w-[40%] min-w-[350px] border-r border-gray-300 flex flex-col overflow-x-auto bg-white">
                        <div class="flex bg-gray-100 border-b border-gray-300 text-xs font-semibold text-gray-600 sticky top-0 z-10 shadow-sm h-12 items-center">
                            <div class="w-10 px-2 border-r border-gray-300 text-center">ID</div>
                            <div class="flex-1 px-2 border-r border-gray-300 min-w-[150px]">Task Name</div>
                            <div class="w-20 px-2 border-r border-gray-300 text-center">Start</div>
                            <div class="w-20 px-2 border-r border-gray-300 text-center">Finish</div>
                            <div class="w-16 px-2 text-center">%</div>
                        </div>
                        <div class="flex-1 overflow-y-auto">
                            ${treeTasks.map((task, index) => {
                                const indentClass = task.level > 0 ? 'pl-6 bg-gray-50/50 border-l-2 border-l-indigo-300' : '';
                                const titlePrefix = task.level > 0 ? '‚Ü≥ ' : '';
                                
                                return `
                                <div draggable="true" ondragstart="window.handleGanttDragStart(event, '${task.id}')" ondragend="window.handleGanttDragEnd(event)" ondragover="window.handleGanttDragOver(event)" ondragenter="window.handleGanttDragEnter(event)" ondragleave="window.handleGanttDragLeave(event)" ondrop="window.handleGanttDrop(event, '${task.id}')" class="flex border-b border-gray-200 text-sm hover:bg-indigo-50 cursor-move h-8 items-center group transition-colors">
                                    <div class="w-10 px-2 text-center text-gray-500 border-r border-gray-200 flex items-center justify-center gap-1" onclick="window.openTaskModal('${task.id}')">
                                        <i data-lucide="grip-vertical" class="w-3 h-3 text-gray-400 opacity-0 group-hover:opacity-100"></i>
                                        ${printConfig && printConfig.type === 'task' ? parseInt(printConfig.taskStart) + index : index + 1}
                                    </div>
                                    <div class="flex-1 px-2 font-medium text-gray-800 border-r border-gray-200 truncate flex justify-between items-center ${indentClass}">
                                        <span class="truncate cursor-pointer" onclick="window.openTaskModal('${task.id}')">${titlePrefix}${task.title}</span>
                                        <div class="flex gap-2">
                                            ${task.level === 0 ? `<i data-lucide="plus-circle" onclick="window.openTaskModal(null, true, '${task.id}')" class="w-3.5 h-3.5 print-hide opacity-0 group-hover:opacity-100 text-green-500 hover:text-green-700 cursor-pointer" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢"></i>` : ''}
                                            <i data-lucide="edit" onclick="window.openTaskModal('${task.id}')" class="w-3.5 h-3.5 print-hide opacity-0 group-hover:opacity-100 text-indigo-500 hover:text-indigo-700 cursor-pointer"></i>
                                        </div>
                                    </div>
                                    <div class="w-20 px-2 text-gray-600 border-r border-gray-200 text-xs cursor-pointer" onclick="window.openTaskModal('${task.id}')">${task.startDate ? task.startDate.substring(5) : '-'}</div>
                                    <div class="w-20 px-2 text-gray-600 border-r border-gray-200 text-xs cursor-pointer" onclick="window.openTaskModal('${task.id}')">${task.dueDate ? task.dueDate.substring(5) : '-'}</div>
                                    <div class="w-16 px-2 text-center text-gray-600 text-xs font-medium cursor-pointer" onclick="window.openTaskModal('${task.id}')">${task.progress || 0}%</div>
                                </div>
                            `}).join('')}
                            ${Array.from({length: Math.max(0, 10 - treeTasks.length)}).map(() => `
                                <div class="flex border-b border-gray-100 h-8">
                                    <div class="w-10 border-r border-gray-100"></div><div class="flex-1 border-r border-gray-100"></div><div class="w-20 border-r border-gray-100"></div><div class="w-20 border-r border-gray-100"></div><div class="w-16"></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Right Pane: Gantt -->
                    <div class="flex-1 flex flex-col overflow-auto bg-white relative">
                        <div class="bg-gray-100 border-b border-gray-300 sticky top-0 z-10 shadow-sm h-12 flex flex-col">
                            <div class="flex border-b border-gray-300 bg-gray-200/50 min-w-max">
                                ${gData.months.map(m => `<div class="flex items-center justify-center text-xs font-bold text-gray-700 border-r border-gray-300 flex-shrink-0" style="width: ${m.colSpan * 32}px">${m.label}</div>`).join('')}
                            </div>
                            <div class="flex min-w-max">
                                ${gData.days.map(day => `<div class="w-8 flex-shrink-0 flex items-center justify-center text-[10px] text-gray-500 border-r border-gray-200 ${day.getDay() === 0 || day.getDay() === 6 ? 'bg-gray-200/50 text-red-400 font-medium' : ''}">${day.getDate()}</div>`).join('')}
                            </div>
                        </div>
                        <div class="flex-1 min-w-max relative">
                            <div class="absolute inset-0 flex pointer-events-none min-w-max">
                                ${gData.days.map(day => `<div class="w-8 flex-shrink-0 border-r border-gray-100 h-full ${day.getDay() === 0 || day.getDay() === 6 ? 'bg-gray-50/80' : ''}"></div>`).join('')}
                            </div>
                            ${treeTasks.map(task => {
                                if (!task.startDate || !task.dueDate) return `<div class="h-8 border-b border-gray-200 ${task.level > 0 ? 'bg-gray-50/20' : ''}"></div>`;
                                const sDate = new Date(task.startDate);
                                const eDate = new Date(task.dueDate);
                                const startOffsetDays = Math.floor((sDate - gData.minDate) / (1000 * 60 * 60 * 24));
                                const durationDays = Math.floor((eDate - sDate) / (1000 * 60 * 60 * 24)) + 1;
                                const leftPos = startOffsetDays * 32; 
                                const barWidth = Math.max(durationDays * 32, 32); 
                                if(leftPos + barWidth < 0) return `<div class="h-8 border-b border-gray-200"></div>`;
                                
                                const finalLeft = Math.max(0, leftPos);
                                const finalWidth = leftPos < 0 ? barWidth + leftPos : barWidth;
                                const labelLeft = Math.max(barWidth, leftPos + barWidth) + 8;

                                return `
                                <div class="h-8 border-b border-gray-200 relative flex items-center gantt-bar-group ${task.level > 0 ? 'bg-gray-50/20' : ''}">
                                    <div onclick="window.openTaskModal('${task.id}')" class="absolute h-5 ${task.level > 0 ? 'bg-green-200 border-green-400 hover:border-green-600' : 'bg-blue-200 border-blue-400 hover:border-blue-600'} border rounded-sm shadow-sm overflow-hidden flex items-center cursor-pointer transition-colors" style="left: ${finalLeft}px; width: ${finalWidth}px">
                                        <div class="h-full ${task.level > 0 ? 'bg-green-500' : 'bg-blue-500'} opacity-80 transition-all" style="width: ${task.progress || 0}%"></div>
                                        <div class="gantt-tooltip print-hide hidden absolute z-20 left-1/2 -translate-x-1/2 top-6 bg-gray-800 text-white text-xs p-1.5 rounded whitespace-nowrap shadow-lg">
                                            <span class="font-semibold">${task.level > 0 ? '‚Ü≥ ' : ''}${task.title}</span><br/>Progress: ${task.progress || 0}%
                                        </div>
                                    </div>
                                    <div class="absolute text-[10px] text-gray-600 whitespace-nowrap" style="left: ${labelLeft}px">${task.assignee}</div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>`;
            return html;
        }

        // --- Styles Helpers ---
        function getPriorityColor(priority) {
            switch(priority) {
                case 'Urgent': return 'bg-red-100 text-red-700 border-red-200';
                case 'High': return 'bg-orange-100 text-orange-700 border-orange-200';
                case 'Medium': return 'bg-blue-100 text-blue-700 border-blue-200';
                case 'Low': return 'bg-gray-100 text-gray-700 border-gray-200';
                default: return 'bg-gray-100 text-gray-700';
            }
        }
        function getStatusColor(status) {
            switch(status) {
                case 'Done': return 'bg-green-100 text-green-700';
                case 'In Progress': return 'bg-blue-100 text-blue-700';
                case 'Review': return 'bg-purple-100 text-purple-700';
                case 'To Do': return 'bg-gray-100 text-gray-700';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        // --- Form / Modals ---
        window.openTaskModal = function(taskId = null, isSubtask = false, parentId = null) {
            const modal = document.getElementById('task-modal');
            const titleEl = document.getElementById('task-modal-title');
            const btnEl = document.getElementById('task-submit-btn');
            const form = document.getElementById('task-form');

            form.reset();
            
            if (isSubtask && parentId) {
                // ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢
                document.getElementById('task-id').value = '';
                document.getElementById('task-parent-id').value = parentId;
                
                const today = new Date().toISOString().split('T')[0];
                const threeDaysLater = new Date(Date.now() + 86400000*3).toISOString().split('T')[0];
                document.getElementById('task-start').value = today;
                document.getElementById('task-due').value = threeDaysLater;
                
                titleEl.innerText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (Sub-task)';
                btnEl.innerText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢';
                
            } else if (taskId) {
                // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                const task = tasks.find(t => t.id === taskId);
                if(task) {
                    document.getElementById('task-id').value = task.id;
                    document.getElementById('task-parent-id').value = task.parentId || '';
                    document.getElementById('task-title').value = task.title;
                    document.getElementById('task-desc').value = task.description || '';
                    document.getElementById('task-assignee').value = task.assignee;
                    document.getElementById('task-priority').value = task.priority || 'Medium';
                    document.getElementById('task-start').value = task.startDate || '';
                    document.getElementById('task-due').value = task.dueDate || '';
                    document.getElementById('task-progress').value = task.progress || 0;
                    titleEl.innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô';
                    btnEl.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                }
            } else {
                // ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà
                document.getElementById('task-id').value = '';
                document.getElementById('task-parent-id').value = '';
                const today = new Date().toISOString().split('T')[0];
                const threeDaysLater = new Date(Date.now() + 86400000*3).toISOString().split('T')[0];
                document.getElementById('task-start').value = today;
                document.getElementById('task-due').value = threeDaysLater;
                titleEl.innerText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
                btnEl.innerText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô';
            }
            modal.classList.remove('hidden');
        }

        window.closeTaskModal = function() {
            document.getElementById('task-modal').classList.add('hidden');
        }

        window.submitTaskForm = function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const id = formData.get('id');
            const parentId = formData.get('parentId') || null;
            const progress = parseInt(formData.get('progress'), 10) || 0;
            
            const taskData = {
                title: formData.get('title'),
                description: formData.get('description'),
                assignee: formData.get('assignee'),
                priority: formData.get('priority'),
                startDate: formData.get('startDate'),
                dueDate: formData.get('dueDate'),
                progress: progress,
                parentId: parentId
            };

            if (id) { // Update
                const existingIndex = tasks.findIndex(t => t.id === id);
                if(existingIndex > -1) {
                    const existingTask = tasks[existingIndex];
                    let newStatus = existingTask.status;
                    if(progress === 100) newStatus = 'Done';
                    else if(progress === 0 && newStatus === 'Done') newStatus = 'To Do';
                    
                    tasks[existingIndex] = { ...existingTask, ...taskData, status: newStatus };
                }
            } else { // Create
                taskData.id = Date.now().toString();
                taskData.status = progress === 100 ? 'Done' : 'To Do';
                tasks.push(taskData);
            }
            saveAndRender();
            window.closeTaskModal();
        }

        window.deleteTask = function(taskId) {
            if(confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å ‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢)')) {
                // ‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ parentId ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
                tasks = tasks.filter(t => t.id !== taskId && t.parentId !== taskId);
                saveAndRender();
            }
        }

        // --- Drag & Drop ---
        window.handleDragStart = function(event, id) {
            draggedTaskId = id;
            event.dataTransfer.effectAllowed = 'move';
            setTimeout(() => { event.target.style.opacity = '0.4'; }, 0);
        }
        window.handleDragEnd = function(event) {
            event.target.style.opacity = '1';
            draggedTaskId = null;
        }
        window.handleDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        window.handleDrop = function(event, newStatus) {
            event.preventDefault();
            if (draggedTaskId) {
                window.handleStatusChange(draggedTaskId, newStatus);
                draggedTaskId = null;
            }
        }

        // --- Gantt Drag & Drop Reordering ---
        window.handleGanttDragStart = function(event, id) {
            draggedTaskId = id;
            event.dataTransfer.effectAllowed = 'move';
            setTimeout(() => { event.target.style.opacity = '0.4'; }, 0);
        }
        window.handleGanttDragEnd = function(event) {
            event.target.style.opacity = '1';
            draggedTaskId = null;
        }
        window.handleGanttDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        window.handleGanttDragEnter = function(event) {
            event.preventDefault();
            event.currentTarget.classList.add('bg-indigo-100');
        }
        window.handleGanttDragLeave = function(event) {
            event.currentTarget.classList.remove('bg-indigo-100');
        }
        window.handleGanttDrop = function(event, targetId) {
            event.preventDefault();
            event.currentTarget.classList.remove('bg-indigo-100');
            if (draggedTaskId && draggedTaskId !== targetId) {
                const fromIndex = tasks.findIndex(t => t.id === draggedTaskId);
                const toIndex = tasks.findIndex(t => t.id === targetId);
                if (fromIndex > -1 && toIndex > -1) {
                    const [movedTask] = tasks.splice(fromIndex, 1);
                    tasks.splice(toIndex, 0, movedTask);
                    saveAndRender();
                }
            }
            draggedTaskId = null;
        }

        // --- Status Change Handler ---
        window.handleStatusChange = function(taskId, newStatus) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if(taskIndex > -1) {
                let newProgress = tasks[taskIndex].progress;
                if (newStatus === 'Done') newProgress = 100;
                else if (newStatus === 'To Do' && newProgress === 100) newProgress = 0;
                
                tasks[taskIndex].status = newStatus;
                tasks[taskIndex].progress = newProgress;
                saveAndRender();
            }
        }

        // --- Print Logic ---
        window.openPrintModal = function() {
            document.getElementById('print-modal').classList.remove('hidden');
            document.getElementById('print-task-end').value = tasks.length || 1;
        }
        window.closePrintModal = function() {
            document.getElementById('print-modal').classList.add('hidden');
        }
        window.updatePrintOptions = function(key, value) {
            printOptions[key] = value;
            document.getElementById('print-task-inputs').classList.toggle('hidden', printOptions.type !== 'task');
            document.getElementById('print-date-inputs').classList.toggle('hidden', printOptions.type !== 'date');
        }
        window.confirmPrint = function() {
            printConfig = { ...printOptions };
            window.closePrintModal();
            renderAll(); // Rerender with filtered data
            
            setTimeout(() => {
                window.print();
                printConfig = null; // Reset
                renderAll();
            }, 500);
        }

        // --- CSV Import/Export ---
        window.handleExportCSV = function() {
            const headers = ['id', 'parentId', 'title', 'description', 'assignee', 'status', 'priority', 'startDate', 'dueDate', 'progress'];
            const csvRows = [headers.join(',')];
            
            tasks.forEach(task => {
                const values = headers.map(header => {
                    let val = task[header] !== undefined && task[header] !== null ? task[header].toString() : '';
                    val = val.replace(/"/g, '""');
                    return `"${val}"`;
                });
                csvRows.push(values.join(','));
            });

            const csvContent = "\uFEFF" + csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `promanage_data_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.handleImportCSV = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const rows = text.split(/\r?\n/).filter(row => row.trim() !== '');
                    if (rows.length <= 1) return; 

                    const headers = rows[0].split(',').map(h => h.replace(/"/g, '').trim());
                    const newTasks = [];

                    for (let i = 1; i < rows.length; i++) {
                        const values = rows[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || rows[i].split(',');
                        let taskObj = {};
                        headers.forEach((header, index) => {
                            let val = values[index] ? values[index].replace(/^"|"$/g, '').replace(/""/g, '"').trim() : '';
                            if (header === 'progress') val = parseInt(val, 10) || 0;
                            taskObj[header] = val;
                        });
                        if(taskObj.id && taskObj.title) newTasks.push(taskObj);
                    }

                    if (newTasks.length > 0) {
                        if(window.confirm(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${newTasks.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                            tasks = newTasks;
                            saveAndRender();
                            alert('‡∏≠‡∏¥‡∏°‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                        }
                    }
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            event.target.value = null; 
        }

        // Start App
        init();

    </script>
</body>
</html>
